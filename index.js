import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const app = express();
const port = process.env.PORT || 8000;

app.use(
  cors({
    origin: "*",
    methods: ["GET", "POST", "PUT", "DELETE"],
  })
);

app.use(express.json());

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});
app.post("/api/chatMessage", async (req, res) => {
  const { message } = req.body;

  if (!message || message.trim() === "") {
    return res.status(400).json({ reply: "ÐÑÑƒÑƒÐ»Ñ‚ Ñ…Ð¾Ð¾ÑÐ¾Ð½ Ð±Ð°Ð¹Ð½Ð°." });
  }

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: `Ð¢Ð° Ð·Ó©Ð²Ñ…Ó©Ð½ Ð¼Ð¾Ð½Ð³Ð¾Ð» Ñ…ÑÐ» Ð´ÑÑÑ€ Ñ…Ð°Ñ€Ð¸ÑƒÐ»Ð´Ð°Ð³ Ð±Ó©Ð³Ó©Ó©Ð´ Ð°ÑÐ»Ð»Ñ‹Ð½ Ñ‚ÑƒÑ€ÑˆÐ»Ð°Ð³Ð°Ñ‚Ð°Ð¹ Ñ…Ò¯Ð½ ÑŽÐ¼, Ð¢Ð°Ð½Ñ‹ Ð½ÑÑ€Ð¸Ð¹Ð½ aylay Ð°Ð¿Ð¿ Ñ‚ÑƒÑÐ»Ð°Ñ… Ñ…Ð¸Ð¹Ð¼ÑÐ» Ð¾ÑŽÑƒÐ½ ÑƒÑ…Ð°Ð°Ð½ ÑŽÐ¼. `,
        },
        { role: "user", content: message },
      ],
      max_tokens: 2000,
    });

    const reply = completion.choices[0].message.content;
    res.json({ reply });
  } catch (error) {
    console.error("Aylay Ð°Ð»Ð´Ð°Ð°:", error.message);

    if (error.status === 429) {
      return res.status(429).json({
        reply: "API ÐºÐ²Ð¾Ñ‚ Ñ…ÑÑ‚ÑÑ€ÑÑÐ½ Ñ‚ÑƒÐ» Ñ…ÑÐ·Ð³Ð°Ð°Ñ€Ð»Ð°Ð³Ð´Ð»Ð°Ð°. Ð”Ð°Ñ€Ð°Ð° Ð´Ð°Ñ…Ð¸Ð½ Ð¾Ñ€Ð¾Ð»Ð´Ð¾Ð½Ð¾ ÑƒÑƒ.",
      });
    }

    res.status(500).json({ reply: "Aylay-ÑÑÑ Ñ…Ð°Ñ€Ð¸Ñƒ Ð°Ð²Ñ‡ Ñ‡Ð°Ð´ÑÐ°Ð½Ð³Ò¯Ð¹." });
  }
});

app.post("/api/chat", async (req, res) => {
  const { message } = req.body;

  if (!message || message.trim() === "") {
    return res.status(400).json({ reply: "ÐÑÑƒÑƒÐ»Ñ‚ Ñ…Ð¾Ð¾ÑÐ¾Ð½ Ð±Ð°Ð¹Ð½Ð°." });
  }

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: `
Ð¢Ð° Ð±Ð¾Ð» ÐœÐ¾Ð½Ð³Ð¾Ð» Ð¾Ñ€Ð½Ñ‹ Ð½ÑƒÑ‚Ð³Ð°Ð°Ñ€ Ð°ÑÐ»Ð¶ Ð±ÑƒÐ¹ Ð¶ÑƒÑƒÐ»Ñ‡Ð´Ð°Ð´ Ð·Ð¾Ñ€Ð¸ÑƒÐ»ÑÐ°Ð½ Ð¼ÑÑ€Ð³ÑÐ¶Ð»Ð¸Ð¹Ð½ AI Ð·Ó©Ð²Ð»Ó©Ñ… ÑŽÐ¼.
Ð¥ÑÑ€ÑÐ³Ð»ÑÐ³Ñ‡Ð¸Ð¹Ð½ Ð°ÑÐ»Ð»Ñ‹Ð½ Ð¼ÑÐ´ÑÑÐ»ÑÐ» Ð´ÑÑÑ€ Ò¯Ð½Ð´ÑÑÐ»ÑÐ½ Ð´Ð¾Ð¾Ñ€Ñ… Ð±Ò¯Ñ‚ÑÑ†Ñ‚ÑÐ¹ Ð°ÑÐ»Ð»Ñ‹Ð½ Ñ‚Ó©Ð»Ó©Ð²Ð»Ó©Ð³Ó©Ó© Ð±Ð¾Ð»Ð¾Ð²ÑÑ€ÑƒÑƒÐ»Ð½Ð° ÑƒÑƒ:

ðŸ“… Ó¨Ð´Ó©Ñ€ Ñ‚ÑƒÑ Ð±Ò¯Ñ€Ð¸Ð¹Ð½ Ñ‚Ó©Ð»Ó©Ð²Ð»Ó©Ð³Ó©Ó©:
- ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚, Ð·Ð°Ð¹, Ð·Ð¾Ñ€Ñ‡Ð¸Ñ… Ñ…ÑƒÐ³Ð°Ñ†Ð°Ð°
- Ò®Ð·ÑÑ… Ð³Ð°Ð·Ñ€ÑƒÑƒÐ´, ÑÐ¾Ð½Ð¸Ñ€Ñ…Ð¾Ð»Ñ‚Ð¾Ð¹ Ò¯Ð¹Ð» Ð°Ð¶Ð¸Ð»Ð»Ð°Ð³Ð°Ð°
- Ó¨Ð´Ñ€Ð¸Ð¹Ð½ Ñ…Ð¾Ð¾Ð»/Ð¾Ñ€Ð¾Ð½ Ð½ÑƒÑ‚Ð³Ð¸Ð¹Ð½ Ð·Ð¾Ð¾Ð³
- Ð¥Ð¾Ð½Ð¾Ð³Ð»Ð¾Ñ… Ð±ÑƒÑƒÐ´Ð°Ð»/Ð¶ÑƒÑƒÐ»Ñ‡Ð½Ñ‹ Ð±Ð°Ð°Ð·

ðŸŽ’ Ð‘ÑÐ»Ñ‚Ð³ÑÑ… Ð·Ò¯Ð¹Ð»Ñ:
- Ð¦Ò¯Ð½Ñ…Ð»ÑÑ… ÑˆÐ°Ð°Ñ€Ð´Ð»Ð°Ð³Ð°Ñ‚Ð°Ð¹ Ð·Ò¯Ð¹Ð»Ñ (ÑƒÐ»Ð¸Ñ€Ð°Ð», Ð³Ð°Ð·Ñ€Ñ‹Ð½ Ð¾Ð½Ñ†Ð»Ð¾Ð³Ð¾Ð¾Ñ Ñ…Ð°Ð¼Ð°Ð°Ñ€ÑƒÑƒÐ»Ð¶)
- Ð£ÑƒÐ»Ñ‹Ð½ Ð³ÑƒÑ‚Ð°Ð», ÑƒÑÐ½Ñ‹ ÑÐ°Ð², Ð½Ð°Ñ€Ð½Ñ‹ Ñ‚Ð¾Ñ, Ñ…Ó©Ð½Ð¶Ð¸Ð», Ð¼Ð°Ð¹Ñ…Ð°Ð½ Ð³ÑÑ… Ð¼ÑÑ‚

ðŸŒ¦ Ð¦Ð°Ð³ Ð°Ð³Ð°Ð°Ñ€Ñ‹Ð½ Ð¼ÑÐ´ÑÑÐ»ÑÐ»:
- Ð¡Ð°Ñ€Ñ‹Ð½ Ð´ÑƒÐ½Ð´Ð°Ð¶ Ñ…ÑÐ¼
- Ò®Ò¯Ð»ÑÑ€Ñ…ÑÐ³ ÑÑÑÑ…, Ñ…ÑƒÑ€ Ñ‚ÑƒÐ½Ð°Ð´Ð°Ñ Ð¾Ñ€Ð´Ð¾Ð³ ÑÑÑÑ…
- Ð¨Ó©Ð½Ð¸Ð¹Ð½ ÑÑÑ€Ò¯Ò¯ÑÑÐ»Ð´ Ð°Ð½Ñ…Ð°Ð°Ñ€ÑƒÑƒÐ»Ð°Ñ…

ðŸ’¸ Ð¡Ð°Ð½Ñ…Ò¯Ò¯Ð³Ð¸Ð¹Ð½ Ñ‚Ó©Ð»Ó©Ð²Ð»Ó©Ð³Ó©Ó© (Ð±Ð°Ñ€Ð°Ð³Ñ†Ð°Ð°):
- ÐÐ¸Ð¹Ñ‚ Ñ…Ð¾Ð½Ð¾Ð³Ð¸Ð¹Ð½ Ð°ÑÐ»Ð»Ñ‹Ð½ Ñ‚Ó©ÑÓ©Ð² (MNT ÑÑÐ²ÑÐ» USD)
- Ð—Ð°Ð¼Ñ‹Ð½ Ð·Ð°Ñ€Ð´Ð°Ð» (Ð½Ð¸ÑÑÑ…, Ð¼Ð°ÑˆÐ¸Ð½ Ñ‚Ò¯Ñ€ÑÑÑ, ÑˆÐ°Ñ‚Ð°Ñ…ÑƒÑƒÐ½)
- Ð‘ÑƒÑƒÐ´Ð°Ð»/Ð±Ð°Ð°Ð·Ñ‹Ð½ Ð´ÑƒÐ½Ð´Ð°Ð¶ Ò¯Ð½Ñ (1 ÑˆÓ©Ð½Ó©)
- Ó¨Ð´Ñ€Ð¸Ð¹Ð½ Ñ…Ð¾Ð¾Ð», Ñ…Ó©Ð½Ð³Ó©Ð½ Ð·ÑƒÑƒÑˆ
- ÐÑÐ¼ÑÐ»Ñ‚ Ð·Ð°Ñ€Ð´Ð»ÑƒÑƒÐ´: Ð¾Ñ€Ð¾Ð½ Ð½ÑƒÑ‚Ð³Ð¸Ð¹Ð½ Ñ…ÑƒÑ€Ð°Ð°Ð¼Ð¶, Ò¯Ð¹Ð» Ð°Ð¶Ð¸Ð»Ð»Ð°Ð³Ð°Ð°Ð½Ñ‹ Ñ‚Ð°ÑÐ°Ð»Ð±Ð°Ñ€

âš ï¸ ÐÐ½Ñ…Ð°Ð°Ñ€Ð°Ñ… Ð·Ò¯Ð¹Ð»Ñ:
- Ð“Ð°Ñ€ ÑƒÑ‚Ð°ÑÐ½Ñ‹ ÑÒ¯Ð»Ð¶ÑÑ, Ð¸Ð½Ñ‚ÐµÑ€Ð½ÑÑ‚
- Ð–ÑƒÑƒÐ»Ñ‡Ð½Ñ‹ Ð°ÑŽÑƒÐ»Ð³Ò¯Ð¹ Ð±Ð°Ð¹Ð´Ð°Ð», Ð°Ð½Ñ…Ð°Ð°Ñ€Ð°Ñ… Ñ‘ÑÑ‚Ð¾Ð¹ Ð·Ð°Ð½ Ð·Ð°Ð½ÑˆÐ¸Ð»
- Ð‘Ð°Ð¹Ð³Ð°Ð»Ð¸Ð¹Ð½ Ð½Ó©Ñ…Ñ†Ó©Ð»Ñ‚ÑÐ¹ Ñ…Ð¾Ð»Ð±Ð¾Ð¾Ñ‚Ð¾Ð¹ ÑÑ€ÑÐ´ÑÐ» (ÑƒÑƒÐ»Ñ‹Ð½ Ð·Ð°Ð¼, Ð³ÑƒÐ»Ð³Ð°Ð° Ð³ÑÑ… Ð¼ÑÑ‚)

ðŸŽ¯ Ð¥ÑÑ€ÑÐ³Ð»ÑÐ³Ñ‡Ð¸Ð¹Ð½ ÑÐ¾Ð½Ð¸Ñ€Ñ…Ð¾Ð»Ð´ Ð½Ð¸Ð¹Ñ†Ò¯Ò¯Ð»Ð¶ Ð°ÑÐ»Ð»Ñ‹Ð³ Ð¾Ð½Ð¾Ð²Ñ‡Ñ‚Ð¾Ð¹ Ð±Ð¾Ð»Ð³Ð¾.
Ð¥Ð°Ñ€Ð¸ÑƒÐ»Ñ‚Ð°Ð° Ñ…ÑÑ€ÑÐ³Ð»ÑÐ³Ñ‡ Ð¾Ð¹Ð»Ð³Ð¾Ð¼Ð¶Ñ‚Ð¾Ð¹, Ð½Ð°Ð¹Ñ€ÑÐ°Ð³ Ð±Ð°Ð¹Ð´Ð»Ð°Ð°Ñ€ Ó©Ð³Ó©Ó©Ñ€ÑÐ¹.
`,
        },
        { role: "user", content: message },
      ],
      max_tokens: 2000,
    });

    const reply = completion.choices[0].message.content;
    res.json({ reply });
  } catch (error) {
    console.error("Aylay Ð°Ð»Ð´Ð°Ð°:", error.message);

    if (error.status === 429) {
      return res.status(429).json({
        reply: "API ÐºÐ²Ð¾Ñ‚ Ñ…ÑÑ‚ÑÑ€ÑÑÐ½ Ñ‚ÑƒÐ» Ñ…ÑÐ·Ð³Ð°Ð°Ñ€Ð»Ð°Ð³Ð´Ð»Ð°Ð°. Ð”Ð°Ñ€Ð°Ð° Ð´Ð°Ñ…Ð¸Ð½ Ð¾Ñ€Ð¾Ð»Ð´Ð¾Ð½Ð¾ ÑƒÑƒ.",
      });
    }

    res.status(500).json({ reply: "Aylay-ÑÑÑ Ñ…Ð°Ñ€Ð¸Ñƒ Ð°Ð²Ñ‡ Ñ‡Ð°Ð´ÑÐ°Ð½Ð³Ò¯Ð¹." });
  }
});

app.listen(port, () => {
  console.log(`Server Ð°Ð¶Ð¸Ð»Ð»Ð°Ð¶ Ð±Ð°Ð¹Ð½Ð°: http://localhost:${port}`);
});
